name: AI Code Review (GLM-4)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD -- . ':(exclude)*.lock' ':(exclude)yarn.lock' ':(exclude)package-lock.json' | head -c 30000 > /tmp/diff.txt

      - name: AI Review
        id: review
        env:
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          DIFF=$(cat /tmp/diff.txt)
          
          if [ -z "$DIFF" ]; then
            echo "No diff found"
            echo "review=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create JSON payload using jq for proper escaping
          jq -n --arg diff "$DIFF" '{
            model: "glm-4.7",
            max_tokens: 2048,
            messages: [{
              role: "user",
              content: ("Review this code diff and provide concise feedback on code quality, potential bugs, and security concerns. Only comment if there are actual issues.\n\nDiff:\n" + $diff)
            }]
          }' > /tmp/payload.json
          
          # Call z.ai API
          RESPONSE=$(curl -s https://api.z.ai/api/anthropic/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ZAI_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/payload.json)
          
          # Extract response text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          
          if [ -z "$REVIEW" ]; then
            echo "API Error: $RESPONSE"
            REVIEW=""
          fi
          
          # Save to output
          {
            echo "review<<EOF"
            echo "$REVIEW"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post or Update Review Comment
        if: steps.review.outputs.review != ''
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- glm4-ai-review -->';
            const review = process.env.REVIEW;
            
            if (!review || review.length < 10) return;
            
            const body = marker + '\n## ðŸ¤– AI Code Review (GLM-4.7)\n\n' + review;
            
            // Find existing comment with marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(c => c.body.includes(marker));
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new comment');
            }
        env:
          REVIEW: ${{ steps.review.outputs.review }}
